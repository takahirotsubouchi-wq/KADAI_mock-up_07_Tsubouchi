<!DOCTYPE html>
<html>

<head>
    <title>CSVからネットワーク図</title>

    <!-- vis-network ライブラリ（最新版のUMDビルド） -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <!-- PapaParse ライブラリ（CSVパーサー） -->
    <script src="js/papaparse.js"></script>

    <!-- -- Tabulatorライブラリ -- -->
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>

    <style>
        #network {
            width: 100%;
            height: 650px;
            border: 1px solid lightgray;
        }
    </style>
</head>


<div>
    <!-- <input id="csv-file" type="file" accept=".csv"> -->
    <h2>自動車技術会2025年春季大会　学術講演会　　-組織間ネットワーク　全組織・全講演-</h2>
    <div id="network" class="network-graph">
        <script>
            const file = "data_full_affiliation_utf.csv";

            Papa.parse(file, {
                download: true,
                delimiter: ",",
                header: true,
                complete: function (results) {

                    const allRows = results.data; // 全データ読み込み
                    console.log("CSV全件:", allRows);

                    // ネットワーク構築用データ
                    const authorCounts = {};
                    const paperSet = new Set();
                    const edges = [];

                    allRows.forEach(({ affiliation, paper }) => {
                        authorCounts[affiliation] = (authorCounts[affiliation] || 0) + 1;
                        paperSet.add(paper);
                        edges.push({ from: affiliation, to: paper });
                    });

                    // ノード生成
                    const nodes = [];

                    // 組織ノード（サイズは論文数に比例）
                    for (const [affiliation, count] of Object.entries(authorCounts)) {
                        nodes.push({
                            id: affiliation,
                            label: `${affiliation}`,
                            group: "affiliation",
                            value: count
                        });
                    }

                    // 論文ノード
                    for (const paper of paperSet) {
                        nodes.push({
                            id: paper,
                            group: "paper"
                        });
                    }

                    // vis.js描画
                    const container = document.getElementById("network");
                    const data = {
                        nodes: new vis.DataSet(nodes),
                        edges: new vis.DataSet(edges)
                    };
                    const options = {
                        nodes: {
                            shape: 'dot',
                            scaling: { min: 5, max: 80 },
                            font: { size: 20 }
                        },
                        groups: {
                            affiliation: {
                                color: { background: '#FF9900', border: '#FF6600' },
                                shape: 'dot'
                            },
                            paper: {
                                color: { background: '#66CCFF', border: '#3399FF' },
                                shape: 'box'
                            }
                        },
                        edges: { smooth: true },
                        
                        physics: { stabilization: false, solver: 'barnesHut' }
                        // physics: {
                        //     enabled: true,
                        //     solver: 'forceAtlas2Based', // または 'barnesHut''forceAtlas2Based'
                        //     forceAtlas2Based: {
                        //         gravitationalConstant: -50,
                        //         centralGravity: 0.01,
                        //         springLength: 100,
                        //         springConstant: 0.01,
                        //         damping: 0.4,
                        //         avoidOverlap: 1 // ノードの重なりを避ける
                        //     },
                        //     stabilization: {
                        //         iterations: 100,
                        //         fit: false
                        //     },
                        // }

                        
                    };
                    const network = new vis.Network(container, data, options);

                    // Tabulator初期表示（全データ）
                    var table = new Tabulator("#output_table", {
                        data: allRows,
                        columns: [
                            { title: "paper", field: "paper" },
                            { title: "title", field: "title" },
                            { title: "affiliation", field: "affiliation" },
                        ]
                    });

                    // ネットワーククリックイベントで絞り込み
                    network.on("click", function (params) {
                        if (params.nodes.length > 0) {
                            const clickedNodeId = params.nodes[0];
                            console.log("Clicked Node:", clickedNodeId);

                            // affiliation または paper に一致する行を抽出
                            const filteredRows = allRows.filter(row =>
                                row.affiliation === clickedNodeId || row.paper === clickedNodeId
                            );

                            // Tabulatorにデータを再設定
                            table.setData(filteredRows);
                        } else {
                            // ノード以外をクリックした場合は全データに戻す
                            table.setData(allRows);
                        }
                    });
                }
            });
        </script>

    </div>

    <div id="output"></div>
    <div id="output_table"></div>


    </body>

</html>